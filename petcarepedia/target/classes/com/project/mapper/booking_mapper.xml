<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="mapper.booking">
	
	<insert id="insert" parameterType="com.project.vo.BookingVo">
		INSERT INTO PCP_BOOKING(bid, bdate, vdate, vtime, bstate, mid, hid)
		values ('B_'||LTRIM(to_char(SEQU_PCP_BOOKING_BID.nextVal, '0000')), sysdate, #{vdate}, #{vtime}, '예약중', #{mid}, #{hid})
	</insert>
	
	<select id="select" resultType="com.project.vo.BookingVo">
		SELECT ROWNUM RNO, BID, to_char(BDATE, 'yyyy-mm-dd') BDATE,  to_char(BDATE, 'yyyy-mm-dd') VDATE, VTIME, BSTATE, MID, HNAME
		FROM (SELECT * FROM PCP_BOOKING B, PCP_HOSPITAL H where b.hid = h.hid ORDER BY BID DESC)
	</select>
	
	<select id="search" parameterType="String" resultType="com.project.vo.BookingVo">
		SELECT BID, BDATE, VDATE, VTIME, BSTATE, MID, B.HID, H.HNAME, H.LOC, H.GLOC, H.TEL
		FROM PCP_BOOKING B, PCP_HOSPITAL H
		WHERE B.HID = H.HID
		AND MID = #{mid}
	</select>
	
	<select id="search1" parameterType="String" resultType="com.project.vo.BookingVo">
		select bid, bdate, vdate, vtime, bstate, mid, hid, hname, loc, gloc, tel, hrink, img
		from(select b.bid bid, b.bdate bdate, b.vdate vdate, b.vtime vtime, b.bstate bstate, b.mid mid, b.hid hid, h.hname hname, 
				h.loc loc, h.gloc gloc, h.tel tel, h.hrink hrink, h.img img 
				from pcp_review r, pcp_booking b, pcp_hospital h, pcp_member m 
				where r.bid(+) = b.bid 
				and b.hid = h.hid and b.mid = m.mid and b.mid = #{mid} and  r.bid is null)
		where vdate < to_char(sysdate,'yyyy-mm-dd') or (vdate = to_char(sysdate,'yyyy-mm-dd') 
		and vtime < to_char(sysdate,'hh24:mi')) order by bid desc

	</select>
	
	<select id="search2" parameterType="String" resultType="com.project.vo.BookingVo">
		SELECT BID, BDATE, VDATE, VTIME, BSTATE, MID, HID, HNAME, LOC, GLOC, TEL,HRINK, IMG
		FROM (SELECT BID, BDATE, VDATE, VTIME, BSTATE, MID, B.HID HID, H.HNAME HNAME, H.LOC LOC, H.GLOC GLOC, H.TEL TEL, H.HRINK HRINK, H.IMG IMG
				FROM PCP_BOOKING B, PCP_HOSPITAL H
				WHERE B.HID = H.HID AND MID = #{mid} AND VDATE = TO_CHAR(SYSDATE,'YYYY-MM-DD'))
		WHERE VTIME >= TO_CHAR(SYSDATE,'HH24:MI') order by bid desc
	</select>
	
	<select id="search3" parameterType="String" resultType="com.project.vo.BookingReviewVo">
		select bid, bdate, vdate, vtime, bstate, mid, hid, hname, loc, gloc, tel, hrink, img
		from(select b.bid bid, b.bdate bdate, b.vdate vdate, b.vtime vtime, b.bstate bstate, b.mid mid, b.hid hid, h.hname hname, 
				h.loc loc, h.gloc gloc, h.tel tel, h.hrink hrink, h.img img 
				from pcp_review r, pcp_booking b, pcp_hospital h, pcp_member m 
				where b.hid = h.hid and b.mid = m.mid and b.mid = #{mid} and b.bid = r.bid) 
		order by bid desc

	</select>

	<select id="search4" parameterType="String" resultType="com.project.vo.BookingVo">
		SELECT BID, BDATE, VDATE, VTIME, BSTATE, MID, HID, HNAME, LOC, GLOC, TEL,HRINK, IMG
		FROM (SELECT BID, BDATE, VDATE, VTIME, BSTATE, MID, B.HID HID, H.HNAME HNAME, H.LOC LOC, H.GLOC GLOC, H.TEL TEL, H.HRINK HRINK, H.IMG IMG
				FROM PCP_BOOKING B, PCP_HOSPITAL H
				WHERE B.HID = H.HID AND MID = #{mid} AND VDATE > TO_CHAR(SYSDATE,'YYYY-MM-DD')) order by bid desc
	</select>
	
	<select id="select2" parameterType="String" resultType="com.project.vo.BookingVo">
		SELECT  ROWNUM RNO, BID, to_char(BDATE, 'yyyy-mm-dd') BDATE,  to_char(BDATE, 'yyyy-mm-dd') VDATE, VTIME, BSTATE, MID
		FROM (SELECT * FROM PCP_BOOKING ORDER BY BID DESC)
				WHERE MID=#{mid}
	</select>
	
	<select id="select3" parameterType="String" resultType="com.project.vo.BookingVo">
		select BID, VDATE, VTIME, MID, B.HID, H.HNAME, H.TEL, H.IMG 
		FROM PCP_BOOKING B, PCP_HOSPITAL H 
		WHERE B.HID = H.HID AND B.bid = #{bid}
	</select>
	
	<select id="reviewCheck" parameterType="map" resultType="com.project.vo.BookingVo">
		SELECT COUNT(*) FROM PCP_BOOKING WHERE HID=#{hid} AND MID=#{mid} AND BSTATE='진료완료'
	</select>
	
	<select id="selectTime" resultType="com.project.vo.BookingVo">
		SELECT HID, HNAME, SUBSTR(HTIME, 0,5 ) 'START',  SUBSTR(HTIME, 7,6 ) 'END'
		FROM PCP_HOSPITAL ORDER BY HID
	</select>
	
	<select id="selectTime2" parameterType="String" resultType="com.project.vo.BookingVo">
		SELECT HID, HNAME, SUBSTR(HTIME, 0,5 ) \"START\",  SUBSTR(HTIME, 7,6 ) \"END\"
		FROM PCP_HOSPITAL WHERE HID=#{hid}
	</select>

	<update id="update" parameterType="com.project.vo.BookingVo">
		UPDATE PCP_BOOKING SET VDATE=#{vdate}, VTIME=#{vtime}, BSTATE=#{bstate} WHERE BID=#{bid}
	</update>

	<delete id="delete" parameterType="String">
		DELETE FROM PCP_BOOKING WHERE BID=#{bid}
	</delete>
</mapper>